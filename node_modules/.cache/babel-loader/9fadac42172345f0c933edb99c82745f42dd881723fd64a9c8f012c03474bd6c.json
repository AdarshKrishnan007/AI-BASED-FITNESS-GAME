{"ast":null,"code":"/**\n * @license\n * Copyright 2021 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\nimport { util } from '@tensorflow/tfjs-core';\nimport { activationFnSnippet, biasActivationSnippet } from './activation_util';\nimport { getMainHeaderString as main } from './webgpu_program';\nimport { computeDispatch, flatDispatchLayout } from './webgpu_util';\nexport class DepthwiseConv2DVec4Program {\n  constructor(convInfo) {\n    let addBias = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    let activation = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    let hasPreluActivation = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n    this.variableNames = ['x', 'W'];\n    this.uniforms = 'pads : vec2<i32>, inDims : vec2<i32>, virtualWidth : i32,';\n    this.workgroupSize = [64, 1, 1];\n    this.workPerThread = 4;\n    this.outputComponent = 4;\n    this.outputShape = convInfo.outShape;\n    this.virtualWidth = Math.ceil(this.outputShape[2] / this.workPerThread) * this.workPerThread;\n    const virtualOutputShape = [this.outputShape[0], this.outputShape[1], this.virtualWidth, this.outputShape[3]];\n    this.dispatchLayout = flatDispatchLayout(virtualOutputShape);\n    this.dispatch = computeDispatch(this.dispatchLayout, virtualOutputShape, this.workgroupSize, [this.outputComponent * this.workPerThread, 1, 1]);\n    util.assert(convInfo.dataFormat === 'channelsLast', () => 'TODO: NCHW is unimplemented');\n    if (addBias) {\n      this.variableNames.push('bias');\n    }\n    if (hasPreluActivation) {\n      this.variableNames.push('preluActivationWeights');\n    }\n    this.convInfo = convInfo;\n    this.addBias = addBias;\n    this.activation = activation;\n    this.hasPreluActivation = hasPreluActivation;\n    this.shaderKey = \"depthwiseVec4_\".concat(activation, \"_\").concat(this.convInfo.filterHeight, \"_\").concat(this.convInfo.filterWidth, \"_\").concat(this.convInfo.strideHeight, \"_\").concat(this.convInfo.strideWidth, \"_\").concat(this.workPerThread);\n  }\n  getUserCode() {\n    const xNumber = (this.workPerThread - 1) * this.convInfo.strideWidth + this.convInfo.filterWidth;\n    const strideHeight = this.convInfo.strideHeight;\n    const strideWidth = this.convInfo.strideWidth;\n    const userCode = \"\\n      \".concat(activationFnSnippet(this.activation, this.hasPreluActivation, true, 4), \"\\n      fn readX(batch : i32, row : i32, col : i32, channel : i32) -> vec4<f32> {\\n        var value = vec4<f32>(0.0);\\n        if (col >=0 && col < uniforms.inDims[1]) {\\n          value = getX(batch, row, col, channel);\\n        }\\n        return value;\\n      }\\n\\n      \").concat(main('index'), \" {\\n        let width0 = uniforms.outShape[3] / \").concat(this.outputComponent, \";\\n        let d1 = (index % width0) * \").concat(this.outputComponent, \";\\n        var index1 = index / width0;\\n        let width1 = uniforms.virtualWidth / \").concat(this.workPerThread, \";\\n        let c = (index1 % width1) * \").concat(this.workPerThread, \";\\n        index1 = index1 / width1;\\n        let r = index1 % uniforms.outShape[1];\\n        let batch = index1 / uniforms.outShape[1];\\n\\n        let xRCCorner = vec2<i32>(r, c) * vec2<i32>(\").concat(strideHeight, \", \").concat(strideWidth, \") - uniforms.pads;\\n\\n        let xRCorner = xRCCorner.x;\\n        let xCCorner = xRCCorner.y;\\n        var xVals : array<vec4<f32>, \").concat(xNumber, \">;\\n        var dotProd : array<vec4<f32>, \").concat(this.workPerThread, \">;\\n        for (var i = 0; i < \").concat(this.workPerThread, \"; i++) {\\n          dotProd[i] = vec4<f32>(0.0);\\n        }\\n\\n        // Use constant instead of uniform can give better performance.\\n        for (var wR = 0; wR < \").concat(this.convInfo.filterHeight, \"; wR = wR + 1) {\\n          let xR = xRCorner + wR;\\n          if (xR >=0 && xR < uniforms.inDims[0]) {\\n            for (var i = 0; i < \").concat(xNumber, \"; i++) {\\n              xVals[i] = readX(batch, xR, xCCorner + i, d1);\\n            }\\n            for (var wC = 0; wC < \").concat(this.convInfo.filterWidth, \"; wC = wC + 1) {\\n              let wValue = getW(wR, wC, d1, 0);\\n              for (var i = 0; i < \").concat(this.workPerThread, \"; i++) {\\n                dotProd[i] = fma(xVals[i * \").concat(strideWidth, \" + wC], wValue, dotProd[i]);\\n              }\\n            }\\n          }\\n        }\\n\\n        for (var i = 0; i < \").concat(this.workPerThread, \"; i = i + 1) {\\n          let coords = vec4<i32>(batch, r, c + i, d1);\\n          if (coordsInBounds4D(coords, uniforms.outShape)) {\\n            var value = dotProd[i];\\n            \").concat(biasActivationSnippet(this.addBias, this.activation), \"\\n            setOutputAtCoords(coords[0], coords[1], coords[2], coords[3], value);\\n          }\\n        }\\n      }\\n    \");\n    return userCode;\n  }\n}","map":{"version":3,"names":["util","activationFnSnippet","biasActivationSnippet","getMainHeaderString","main","computeDispatch","flatDispatchLayout","DepthwiseConv2DVec4Program","constructor","convInfo","addBias","arguments","length","undefined","activation","hasPreluActivation","variableNames","uniforms","workgroupSize","workPerThread","outputComponent","outputShape","outShape","virtualWidth","Math","ceil","virtualOutputShape","dispatchLayout","dispatch","assert","dataFormat","push","shaderKey","concat","filterHeight","filterWidth","strideHeight","strideWidth","getUserCode","xNumber","userCode"],"sources":["D:\\Fitness WebApp\\tfjs-backend-webgpu\\src\\depthwise_conv2d_vec4_webgpu.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\n\nimport {backend_util, util} from '@tensorflow/tfjs-core';\nimport {activationFnSnippet, biasActivationSnippet} from './activation_util';\nimport {getMainHeaderString as main, WebGPUProgram} from './webgpu_program';\nimport {computeDispatch, flatDispatchLayout} from './webgpu_util';\n\nexport class DepthwiseConv2DVec4Program implements WebGPUProgram {\n  outputShape: number[];\n  shaderKey: string;\n  dispatchLayout: {x: number[]};\n  dispatch: [number, number, number];\n  variableNames = ['x', 'W'];\n  uniforms = 'pads : vec2<i32>, inDims : vec2<i32>, virtualWidth : i32,';\n  workgroupSize: [number, number, number] = [64, 1, 1];\n  workPerThread = 4;\n  convInfo: backend_util.Conv2DInfo;\n  addBias: boolean;\n  activation: backend_util.Activation;\n  hasPreluActivation: boolean;\n  outputComponent = 4;\n  virtualWidth: number;\n\n  constructor(\n      convInfo: backend_util.Conv2DInfo, addBias = false,\n      activation: backend_util.Activation = null, hasPreluActivation = false) {\n    this.outputShape = convInfo.outShape;\n    this.virtualWidth = Math.ceil(this.outputShape[2] / this.workPerThread) *\n        this.workPerThread;\n    const virtualOutputShape = [\n      this.outputShape[0], this.outputShape[1], this.virtualWidth,\n      this.outputShape[3]\n    ];\n    this.dispatchLayout = flatDispatchLayout(virtualOutputShape);\n\n    this.dispatch = computeDispatch(\n        this.dispatchLayout, virtualOutputShape, this.workgroupSize,\n        [this.outputComponent * this.workPerThread, 1, 1]);\n\n    util.assert(\n        convInfo.dataFormat === 'channelsLast',\n        () => 'TODO: NCHW is unimplemented');\n\n    if (addBias) {\n      this.variableNames.push('bias');\n    }\n    if (hasPreluActivation) {\n      this.variableNames.push('preluActivationWeights');\n    }\n\n    this.convInfo = convInfo;\n    this.addBias = addBias;\n    this.activation = activation;\n    this.hasPreluActivation = hasPreluActivation;\n\n    this.shaderKey =\n        `depthwiseVec4_${activation}_${this.convInfo.filterHeight}_${\n            this.convInfo.filterWidth}_${this.convInfo.strideHeight}_${\n            this.convInfo.strideWidth}_${this.workPerThread}`;\n  }\n\n  getUserCode(): string {\n    const xNumber = (this.workPerThread - 1) * this.convInfo.strideWidth +\n        this.convInfo.filterWidth;\n    const strideHeight = this.convInfo.strideHeight;\n    const strideWidth = this.convInfo.strideWidth;\n\n    const userCode = `\n      ${activationFnSnippet(this.activation, this.hasPreluActivation, true, 4)}\n      fn readX(batch : i32, row : i32, col : i32, channel : i32) -> vec4<f32> {\n        var value = vec4<f32>(0.0);\n        if (col >=0 && col < uniforms.inDims[1]) {\n          value = getX(batch, row, col, channel);\n        }\n        return value;\n      }\n\n      ${main('index')} {\n        let width0 = uniforms.outShape[3] / ${this.outputComponent};\n        let d1 = (index % width0) * ${this.outputComponent};\n        var index1 = index / width0;\n        let width1 = uniforms.virtualWidth / ${this.workPerThread};\n        let c = (index1 % width1) * ${this.workPerThread};\n        index1 = index1 / width1;\n        let r = index1 % uniforms.outShape[1];\n        let batch = index1 / uniforms.outShape[1];\n\n        let xRCCorner = vec2<i32>(r, c) * vec2<i32>(${strideHeight}, ${\n        strideWidth}) - uniforms.pads;\n\n        let xRCorner = xRCCorner.x;\n        let xCCorner = xRCCorner.y;\n        var xVals : array<vec4<f32>, ${xNumber}>;\n        var dotProd : array<vec4<f32>, ${this.workPerThread}>;\n        for (var i = 0; i < ${this.workPerThread}; i++) {\n          dotProd[i] = vec4<f32>(0.0);\n        }\n\n        // Use constant instead of uniform can give better performance.\n        for (var wR = 0; wR < ${this.convInfo.filterHeight}; wR = wR + 1) {\n          let xR = xRCorner + wR;\n          if (xR >=0 && xR < uniforms.inDims[0]) {\n            for (var i = 0; i < ${xNumber}; i++) {\n              xVals[i] = readX(batch, xR, xCCorner + i, d1);\n            }\n            for (var wC = 0; wC < ${this.convInfo.filterWidth}; wC = wC + 1) {\n              let wValue = getW(wR, wC, d1, 0);\n              for (var i = 0; i < ${this.workPerThread}; i++) {\n                dotProd[i] = fma(xVals[i * ${\n        strideWidth} + wC], wValue, dotProd[i]);\n              }\n            }\n          }\n        }\n\n        for (var i = 0; i < ${this.workPerThread}; i = i + 1) {\n          let coords = vec4<i32>(batch, r, c + i, d1);\n          if (coordsInBounds4D(coords, uniforms.outShape)) {\n            var value = dotProd[i];\n            ${biasActivationSnippet(this.addBias, this.activation)}\n            setOutputAtCoords(coords[0], coords[1], coords[2], coords[3], value);\n          }\n        }\n      }\n    `;\n    return userCode;\n  }\n}\n"],"mappings":"AAAA;;;;;;;;;;;;;;;;AAiBA,SAAsBA,IAAI,QAAO,uBAAuB;AACxD,SAAQC,mBAAmB,EAAEC,qBAAqB,QAAO,mBAAmB;AAC5E,SAAQC,mBAAmB,IAAIC,IAAI,QAAsB,kBAAkB;AAC3E,SAAQC,eAAe,EAAEC,kBAAkB,QAAO,eAAe;AAEjE,OAAM,MAAOC,0BAA0B;EAgBrCC,YACIC,QAAiC,EACqC;IAAA,IADnCC,OAAO,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;IAAA,IAClDG,UAAA,GAAAH,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAsC,IAAI;IAAA,IAAEI,kBAAkB,GAAAJ,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;IAb1E,KAAAK,aAAa,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC;IAC1B,KAAAC,QAAQ,GAAG,2DAA2D;IACtE,KAAAC,aAAa,GAA6B,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC;IACpD,KAAAC,aAAa,GAAG,CAAC;IAKjB,KAAAC,eAAe,GAAG,CAAC;IAMjB,IAAI,CAACC,WAAW,GAAGZ,QAAQ,CAACa,QAAQ;IACpC,IAAI,CAACC,YAAY,GAAGC,IAAI,CAACC,IAAI,CAAC,IAAI,CAACJ,WAAW,CAAC,CAAC,CAAC,GAAG,IAAI,CAACF,aAAa,CAAC,GACnE,IAAI,CAACA,aAAa;IACtB,MAAMO,kBAAkB,GAAG,CACzB,IAAI,CAACL,WAAW,CAAC,CAAC,CAAC,EAAE,IAAI,CAACA,WAAW,CAAC,CAAC,CAAC,EAAE,IAAI,CAACE,YAAY,EAC3D,IAAI,CAACF,WAAW,CAAC,CAAC,CAAC,CACpB;IACD,IAAI,CAACM,cAAc,GAAGrB,kBAAkB,CAACoB,kBAAkB,CAAC;IAE5D,IAAI,CAACE,QAAQ,GAAGvB,eAAe,CAC3B,IAAI,CAACsB,cAAc,EAAED,kBAAkB,EAAE,IAAI,CAACR,aAAa,EAC3D,CAAC,IAAI,CAACE,eAAe,GAAG,IAAI,CAACD,aAAa,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;IAEtDnB,IAAI,CAAC6B,MAAM,CACPpB,QAAQ,CAACqB,UAAU,KAAK,cAAc,EACtC,MAAM,6BAA6B,CAAC;IAExC,IAAIpB,OAAO,EAAE;MACX,IAAI,CAACM,aAAa,CAACe,IAAI,CAAC,MAAM,CAAC;;IAEjC,IAAIhB,kBAAkB,EAAE;MACtB,IAAI,CAACC,aAAa,CAACe,IAAI,CAAC,wBAAwB,CAAC;;IAGnD,IAAI,CAACtB,QAAQ,GAAGA,QAAQ;IACxB,IAAI,CAACC,OAAO,GAAGA,OAAO;IACtB,IAAI,CAACI,UAAU,GAAGA,UAAU;IAC5B,IAAI,CAACC,kBAAkB,GAAGA,kBAAkB;IAE5C,IAAI,CAACiB,SAAS,oBAAAC,MAAA,CACOnB,UAAU,OAAAmB,MAAA,CAAI,IAAI,CAACxB,QAAQ,CAACyB,YAAY,OAAAD,MAAA,CACrD,IAAI,CAACxB,QAAQ,CAAC0B,WAAW,OAAAF,MAAA,CAAI,IAAI,CAACxB,QAAQ,CAAC2B,YAAY,OAAAH,MAAA,CACvD,IAAI,CAACxB,QAAQ,CAAC4B,WAAW,OAAAJ,MAAA,CAAI,IAAI,CAACd,aAAa,CAAE;EAC3D;EAEAmB,WAAWA,CAAA;IACT,MAAMC,OAAO,GAAG,CAAC,IAAI,CAACpB,aAAa,GAAG,CAAC,IAAI,IAAI,CAACV,QAAQ,CAAC4B,WAAW,GAChE,IAAI,CAAC5B,QAAQ,CAAC0B,WAAW;IAC7B,MAAMC,YAAY,GAAG,IAAI,CAAC3B,QAAQ,CAAC2B,YAAY;IAC/C,MAAMC,WAAW,GAAG,IAAI,CAAC5B,QAAQ,CAAC4B,WAAW;IAE7C,MAAMG,QAAQ,cAAAP,MAAA,CACVhC,mBAAmB,CAAC,IAAI,CAACa,UAAU,EAAE,IAAI,CAACC,kBAAkB,EAAE,IAAI,EAAE,CAAC,CAAC,wRAAAkB,MAAA,CAStE7B,IAAI,CAAC,OAAO,CAAC,sDAAA6B,MAAA,CACyB,IAAI,CAACb,eAAe,6CAAAa,MAAA,CAC5B,IAAI,CAACb,eAAe,4FAAAa,MAAA,CAEX,IAAI,CAACd,aAAa,6CAAAc,MAAA,CAC3B,IAAI,CAACd,aAAa,sMAAAc,MAAA,CAKFG,YAAY,QAAAH,MAAA,CAC1DI,WAAW,2IAAAJ,MAAA,CAIoBM,OAAO,iDAAAN,MAAA,CACL,IAAI,CAACd,aAAa,sCAAAc,MAAA,CAC7B,IAAI,CAACd,aAAa,4KAAAc,MAAA,CAKhB,IAAI,CAACxB,QAAQ,CAACyB,YAAY,+IAAAD,MAAA,CAGxBM,OAAO,+HAAAN,MAAA,CAGL,IAAI,CAACxB,QAAQ,CAAC0B,WAAW,2GAAAF,MAAA,CAEzB,IAAI,CAACd,aAAa,2DAAAc,MAAA,CAE9CI,WAAW,0HAAAJ,MAAA,CAMW,IAAI,CAACd,aAAa,6LAAAc,MAAA,CAIlC/B,qBAAqB,CAAC,IAAI,CAACQ,OAAO,EAAE,IAAI,CAACI,UAAU,CAAC,+HAK7D;IACD,OAAO0B,QAAQ;EACjB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}