{"ast":null,"code":"/**\n * @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\nexport class BufferManager {\n  constructor(device) {\n    this.device = device;\n    this.numUsedBuffers = 0;\n    this.numFreeBuffers = 0;\n    this.freeBuffers = new Map();\n    this.usedBuffers = new Map();\n    this.numBytesUsed = 0;\n    this.numBytesAllocated = 0;\n  }\n  acquireBuffer(size, usage) {\n    let mappedAtCreation = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    let reuse = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n    let buffer;\n    const key = getBufferKey(size, usage);\n    if (reuse) {\n      if (!this.freeBuffers.has(key)) {\n        this.freeBuffers.set(key, []);\n      }\n      if (this.freeBuffers.get(key).length > 0) {\n        buffer = this.freeBuffers.get(key).pop();\n        this.numFreeBuffers--;\n      } else {\n        buffer = this.device.createBuffer({\n          size,\n          usage,\n          mappedAtCreation\n        });\n        this.numBytesAllocated += size;\n      }\n    } else {\n      buffer = this.device.createBuffer({\n        size,\n        usage,\n        mappedAtCreation\n      });\n      this.numBytesAllocated += size;\n    }\n    if (!this.usedBuffers.has(key)) {\n      this.usedBuffers.set(key, []);\n    }\n    this.usedBuffers.get(key).push(buffer);\n    this.numUsedBuffers++;\n    this.numBytesUsed += size;\n    return buffer;\n  }\n  releaseBuffer(buffer) {\n    let reuse = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    if (this.freeBuffers.size === 0) {\n      return;\n    }\n    const size = buffer.size;\n    const usage = buffer.usage;\n    const key = getBufferKey(size, usage);\n    const bufferArray = this.usedBuffers.get(key);\n    const index = bufferArray.indexOf(buffer);\n    if (index < 0) {\n      throw new Error('Cannot find the buffer in buffer manager');\n    }\n    bufferArray[index] = bufferArray[bufferArray.length - 1];\n    bufferArray.pop();\n    this.numUsedBuffers--;\n    this.numBytesUsed -= size;\n    if (reuse) {\n      this.freeBuffers.get(key).push(buffer);\n      this.numFreeBuffers++;\n    } else {\n      buffer.destroy();\n      this.numBytesAllocated -= size;\n    }\n  }\n  getNumUsedBuffers() {\n    return this.numUsedBuffers;\n  }\n  getNumFreeBuffers() {\n    return this.numFreeBuffers;\n  }\n  dispose() {\n    this.freeBuffers.forEach((buffers, key) => {\n      buffers.forEach(buffer => {\n        buffer.destroy();\n      });\n    });\n    this.usedBuffers.forEach((buffers, key) => {\n      buffers.forEach(buffer => {\n        buffer.destroy();\n      });\n    });\n    this.freeBuffers = new Map();\n    this.usedBuffers = new Map();\n    this.numUsedBuffers = 0;\n    this.numFreeBuffers = 0;\n    this.numBytesUsed = 0;\n    this.numBytesAllocated = 0;\n  }\n}\nfunction getBufferKey(size, usage) {\n  return \"\".concat(size, \"_\").concat(usage);\n}","map":{"version":3,"names":["BufferManager","constructor","device","numUsedBuffers","numFreeBuffers","freeBuffers","Map","usedBuffers","numBytesUsed","numBytesAllocated","acquireBuffer","size","usage","mappedAtCreation","arguments","length","undefined","reuse","buffer","key","getBufferKey","has","set","get","pop","createBuffer","push","releaseBuffer","bufferArray","index","indexOf","Error","destroy","getNumUsedBuffers","getNumFreeBuffers","dispose","forEach","buffers","concat"],"sources":["D:\\Fitness WebApp\\tfjs-backend-webgpu\\src\\buffer_manager.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\n\nexport class BufferManager {\n  private numUsedBuffers = 0;\n  private numFreeBuffers = 0;\n  private freeBuffers: Map<string, GPUBuffer[]> = new Map();\n  private usedBuffers: Map<string, GPUBuffer[]> = new Map();\n\n  public numBytesUsed = 0;\n  public numBytesAllocated = 0;\n\n  constructor(private device: GPUDevice) {}\n\n  acquireBuffer(\n      size: number, usage: GPUBufferUsageFlags, mappedAtCreation = false,\n      reuse = true) {\n    let buffer;\n    const key = getBufferKey(size, usage);\n\n    if (reuse) {\n      if (!this.freeBuffers.has(key)) {\n        this.freeBuffers.set(key, []);\n      }\n\n      if (this.freeBuffers.get(key).length > 0) {\n        buffer = this.freeBuffers.get(key).pop();\n        this.numFreeBuffers--;\n      } else {\n        buffer = this.device.createBuffer({size, usage, mappedAtCreation});\n        this.numBytesAllocated += size;\n      }\n    } else {\n      buffer = this.device.createBuffer({size, usage, mappedAtCreation});\n      this.numBytesAllocated += size;\n    }\n\n    if (!this.usedBuffers.has(key)) {\n      this.usedBuffers.set(key, []);\n    }\n    this.usedBuffers.get(key).push(buffer);\n    this.numUsedBuffers++;\n    this.numBytesUsed += size;\n\n    return buffer;\n  }\n\n  releaseBuffer(buffer: GPUBuffer, reuse = true) {\n    if (this.freeBuffers.size === 0) {\n      return;\n    }\n\n    const size = buffer.size;\n    const usage = buffer.usage;\n\n    const key = getBufferKey(size, usage);\n    const bufferArray = this.usedBuffers.get(key);\n    const index = bufferArray.indexOf(buffer);\n    if (index < 0) {\n      throw new Error('Cannot find the buffer in buffer manager');\n    }\n    bufferArray[index] = bufferArray[bufferArray.length - 1];\n    bufferArray.pop();\n    this.numUsedBuffers--;\n    this.numBytesUsed -= size;\n\n    if (reuse) {\n      this.freeBuffers.get(key).push(buffer);\n      this.numFreeBuffers++;\n    } else {\n      buffer.destroy();\n      this.numBytesAllocated -= size;\n    }\n  }\n\n  getNumUsedBuffers(): number {\n    return this.numUsedBuffers;\n  }\n\n  getNumFreeBuffers(): number {\n    return this.numFreeBuffers;\n  }\n\n  dispose() {\n    this.freeBuffers.forEach((buffers, key) => {\n      buffers.forEach(buffer => {\n        buffer.destroy();\n      });\n    });\n\n    this.usedBuffers.forEach((buffers, key) => {\n      buffers.forEach(buffer => {\n        buffer.destroy();\n      });\n    });\n\n    this.freeBuffers = new Map();\n    this.usedBuffers = new Map();\n    this.numUsedBuffers = 0;\n    this.numFreeBuffers = 0;\n    this.numBytesUsed = 0;\n    this.numBytesAllocated = 0;\n  }\n}\n\nfunction getBufferKey(size: number, usage: GPUBufferUsageFlags) {\n  return `${size}_${usage}`;\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}